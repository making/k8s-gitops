apiVersion: v1
kind: ConfigMap
metadata:
  name: haproxy-config
  namespace: haproxy
  annotations:
    kapp.k14s.io/versioned: ""
data:
  haproxy.cfg: |
    global
      log stdout format raw local0
      maxconn 4096
      user haproxy
      group haproxy
      daemon

    defaults
      log     global
      mode    tcp
      option  dontlognull
      timeout connect 5s
      timeout client  600s
      timeout server  600s

    # LDAP routing (389)
    frontend ldap_frontend
      bind *:8389
      mode tcp
      # option tcplog
      no log
      default_backend ldap_backend

    backend ldap_backend
      mode tcp
      server openldap openldap-stack-ha.openldap.svc.cluster.local:389 check

    # LDAPS routing (636)
    frontend ldaps_frontend
      bind *:8636
      mode tcp
      # option tcplog
      no log
      default_backend ldaps_backend

    backend ldaps_backend
      mode tcp
      server openldap openldap-stack-ha.openldap.svc.cluster.local:636 check inter 5s fall 3 rise 2

    # Minecraft/Cloudflared routing (25565)
    frontend minecraft_frontend
      bind *:25565
      mode tcp
      # option tcplog
      no log
      default_backend minecraft_backend
    
    backend minecraft_backend
      mode tcp
      server cloudflared cloudflared.cloudflared.svc.cluster.local:25565 check

    # Minecraft Vanilla/Cloudflared routing (25565)
    frontend mc_vanilla_frontend
      bind *:35565
      mode tcp
      # option tcplog
      no log
      default_backend mc_vanilla_backend
    
    backend mc_vanilla_backend
      mode tcp
      server cloudflared cloudflared.cloudflared.svc.cluster.local:35565 check

    # otelcol/vault_audit routing (9090)
    frontend otelcol_vault_audit_frontend
      bind *:9090
      mode tcp
      # option tcplog
      no log
      default_backend otelcol_vault_audit_backend
    
    backend otelcol_vault_audit_backend
      mode tcp
      server otelcol_vault_audit otel-collector.opentelemetry.svc.cluster.local:9090 check

    # HTTP routing (80) with host-based routing
    frontend http_frontend
      bind *:8080
      mode http
      option httplog
      # Track request rate per client IP (1 second window, 100k entries, 30s expiry)
      stick-table type ip size 100k expire 30s store http_req_rate(1s)
      # Blocked IPs
      acl blocked src -f /usr/local/etc/haproxy/blocked-ips.txt
      tcp-request connection reject if blocked
      # Record client IP in the stick-table
      http-request track-sc0 src
      # Reject with 429 Too Many Requests if rate exceeds 10 req/sec
      http-request deny deny_status 429 if { sc_http_req_rate(0) gt 10 }

      default_backend traefik_http_backend
    
    backend traefik_http_backend
      mode http
      server traefik traefik.traefik.svc.cluster.local:80 check send-proxy-v2

    # HTTPS routing (443) with SNI-based routing
    frontend https_frontend
      bind *:8443
      mode tcp
      option tcplog
      # Track connection rate per client IP (60 seconds window, 100k entries, 60s expiry)
      stick-table type ip size 100k expire 60s store conn_rate(60s)
      # Blocked IPs
      acl blocked src -f /usr/local/etc/haproxy/blocked-ips.txt
      tcp-request connection reject if blocked
      # Record client IP at connection level
      tcp-request connection track-sc0 src
      # Reject connection if rate exceeds 50 conn/sec
      tcp-request connection reject if { sc_conn_rate(0) gt 50 }
      # Extract SNI for routing decisions
      tcp-request inspect-delay 5s
      tcp-request content accept if { req_ssl_hello_type 1 }

      default_backend traefik_https_backend
    
    backend traefik_https_backend
      mode tcp
      server traefik traefik.traefik.svc.cluster.local:443 check send-proxy-v2

---